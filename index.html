<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>所得割 完全対応版</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
</head>
<body>

<h2>市民税＋県民税 所得割合算（完全対応版）</h2>

<input type="file" id="imageInput">
<br><br>
<button onclick="runOCR()">読み取り</button>

<p id="result"></p>

<script>
function runOCR() {

  const file = document.getElementById('imageInput').files[0];
  if (!file) return;

  Tesseract.recognize(file, 'jpn')
  .then(({ data }) => {

    const words = data.words;

    let cityTax = 0;
    let prefTax = 0;

    words.forEach(word => {

      if (word.text.includes("所得")) {

        const y = word.bbox.y0;

        // 同じ高さで右側の文字を取得
        const sameLineRight = words.filter(w =>
          Math.abs(w.bbox.y0 - y) < 15 &&
          w.bbox.x0 > word.bbox.x1
        );

        // 数字だけ抽出
        let digits = "";

        sameLineRight.forEach(w => {
          if (/^[0-9]$/.test(w.text)) {
            digits += w.text;
          }
          if (/^[0-9,]+$/.test(w.text)) {
            digits += w.text.replace(/,/g, "");
          }
        });

        if (digits.length > 0) {

          // 左側の税区分取得
          const leftSide = words.filter(w =>
            Math.abs(w.bbox.y0 - y) < 15 &&
            w.bbox.x1 < word.bbox.x0
          );

          const context = leftSide.map(w => w.text).join("");

          if (context.match(/市民税|区民税|町民税/)) {
            cityTax = Number(digits);
          }

          if (context.match(/県民税|都民税|道民税|府民税/)) {
            prefTax = Number(digits);
          }
        }
      }
    });

    const total = cityTax + prefTax;

    document.getElementById("result").innerHTML =
      "市民税所得割: " + cityTax.toLocaleString() + " 円<br>" +
      "県民税所得割: " + prefTax.toLocaleString() + " 円<br><br>" +
      "<strong>合計: " + total.toLocaleString() + " 円</strong>";

  });
}
</script>

</body>
</html>
