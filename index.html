<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>所得割 高精度抽出</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
</head>
<body>
  <h2>市民税＋県民税 所得割合算（高精度版）</h2>

  <input type="file" id="imageInput">
  <br><br>
  <button onclick="runOCR()">読み取り</button>

  <p id="result"></p>

  <script>
    function runOCR() {
      const file = document.getElementById('imageInput').files[0];
      if (!file) return;

      Tesseract.recognize(
        file,
        'jpn',
        { logger: m => console.log(m) }
      ).then(({ data }) => {

        const words = data.words;

        let cityTax = 0;
        let prefectureTax = 0;

        for (let i = 0; i < words.length; i++) {

          const word = words[i].text;

          // 「所得割」を検出
          if (word.includes("所得割")) {

            // 右側の単語を順に確認
            for (let j = i + 1; j < i + 6 && j < words.length; j++) {

              const candidate = words[j].text.replace(/,/g, "");

              if (/^\d+$/.test(candidate)) {

                // 左側に市民税 or 県民税があるか確認
                const context = words.slice(Math.max(0, i - 5), i)
                                     .map(w => w.text)
                                     .join("");

                if (context.match(/市民税|区民税|町民税/)) {
                  cityTax = Number(candidate);
                }

                if (context.match(/県民税|都民税|道民税|府民税/)) {
                  prefectureTax = Number(candidate);
                }

                break;
              }
            }
          }
        }

        const total = cityTax + prefectureTax;

        document.getElementById("result").innerHTML =
          "市民税所得割: " + cityTax.toLocaleString() + " 円<br>" +
          "県民税所得割: " + prefectureTax.toLocaleString() + " 円<br><br>" +
          "<strong>合計: " + total.toLocaleString() + " 円</strong>";
      });
    }
  </script>
</body>
</html>
