<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>所得割 座標解析版</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
</head>
<body>

<h2>市民税＋県民税 所得割合算（最安定版）</h2>

<input type="file" id="imageInput">
<br><br>
<button onclick="runOCR()">読み取り</button>

<p id="result"></p>

<script>
function runOCR() {

  const file = document.getElementById('imageInput').files[0];
  if (!file) return;

  Tesseract.recognize(file, 'jpn')
  .then(({ data }) => {

    const words = data.words;

    let cityTax = 0;
    let prefTax = 0;

    words.forEach((word, index) => {

      if (word.text.includes("所得")) {

        const y = word.bbox.y0;

        // 同じ高さ付近の単語を探す
        words.forEach(candidate => {

          const sameLine = Math.abs(candidate.bbox.y0 - y) < 15;

          if (sameLine) {

            const num = candidate.text.replace(/,/g, "");

            if (/^\d+$/.test(num)) {

              // 左側にある税区分を探す
              const leftWords = words.filter(w =>
                w.bbox.x1 < word.bbox.x0 &&
                Math.abs(w.bbox.y0 - y) < 15
              );

              const context = leftWords.map(w => w.text).join("");

              if (context.match(/市民税|区民税|町民税/)) {
                cityTax = Number(num);
              }

              if (context.match(/県民税|都民税|道民税|府民税/)) {
                prefTax = Number(num);
              }
            }
          }
        });
      }
    });

    const total = cityTax + prefTax;

    document.getElementById("result").innerHTML =
      "市民税所得割: " + cityTax.toLocaleString() + " 円<br>" +
      "県民税所得割: " + prefTax.toLocaleString() + " 円<br><br>" +
      "<strong>合計: " + total.toLocaleString() + " 円</strong>";
  });
}
</script>

</body>
</html>
